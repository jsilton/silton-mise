name: The Kitchen Brigade

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

permissions:
  contents: write
  pull-requests: write

jobs:
  # 1. PREP & SERVICE (Self-Healing Pipeline)
  kitchen-service:
    name: 'Kitchen Prep & Service'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Ingredients
        run: npm ci

      # --- EXPEDITOR STATION (Data) ---
      - name: Expeditor Check (Data Validation)
        run: node scripts/validate_recipes.js

      # --- SOUS CHEF STATION (Style) ---
      - name: Sous Chef Check (Formatting)
        run: npx prettier --write .

      # --- SELF-HEALING COMMIT ---
      - name: Commit Fixes (if any)
        id: auto-commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'style: Kitchen Brigade auto-fixes [skip ci]'
          branch: ${{ github.head_ref }}
          commit_user_name: 'Mise Sous Chef'
          commit_user_email: 'sous-chef@mise.kitchen'
          skip_dirty_check: false

      # --- EXECUTION (Build) ---
      - name: Fire the Oven (Build)
        run: npm run build

  # 2. THE MAÎTRE D' (AI Review)
  # This job is non-critical and will continue on error (e.g. quota exhaustion)
  maitre-d:
    name: "Maître d' (AI Review)"
    needs: kitchen-service
    if: success()
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Read The Codex
        id: codex
        run: |
          content=$(cat CONTRIBUTING.md)
          echo "codex<<EOF" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Consult the Executive Chef        if: ${{ secrets.GEMINI_API_KEY != '' || secrets.GCP_PROJECT_ID != '' }}        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: >
            You are the Maître d' of the Master Kitchen.
            The kitchen staff (CI pipeline) has just processed a new update.

            CONTEXT:
            - Codex: ${{ steps.codex.outputs.codex }}
            - Commit: "${{ github.event.head_commit.message }}"

            TASK:
            1. Summarize the changes in 1 sentence.
            2. If the commit was an "auto-fix" (check the message), praise the kitchen staff for their diligence.
            3. Confirm the "Culinary Standard" is maintained.
            4. Sign off with "Service is Go!"
