---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const meals = await getCollection('meals');
const recipes = await getCollection('recipes');
const recipeMap = new Map(recipes.map((r) => [r.slug, r]));

meals.sort((a, b) => a.data.title.localeCompare(b.data.title));

// Group by template
const mealsByTemplate = meals.reduce(
  (acc, meal) => {
    const template = meal.data.template || 'other';
    if (!acc[template]) acc[template] = [];
    acc[template].push(meal);
    return acc;
  },
  {} as Record<string, typeof meals>
);

const templateLabels: Record<string, string> = {
  plate: 'Plates',
  bowl: 'Bowls',
  'pasta-night': 'Pasta Nights',
  'soup-and-side': 'Soup & Sides',
  'one-pot': 'One-Pot Meals',
  grazing: 'Grazing & Feasts',
  other: 'Other',
};

const templateDescriptions: Record<string, string> = {
  plate: 'Classic protein + sides combinations',
  bowl: 'Everything-in-one-bowl meals',
  'pasta-night': 'Italian-inspired pasta dinners',
  'soup-and-side': 'Warming soup with accompaniments',
  'one-pot': 'Simple meals, minimal cleanup',
  grazing: 'Spread-style meals for sharing',
  other: 'Unique meal combinations',
};

const templateIcons: Record<string, string> = {
  plate: 'üçΩÔ∏è',
  bowl: 'ü•£',
  'pasta-night': 'üçù',
  'soup-and-side': 'üç≤',
  'one-pot': 'ü•ò',
  grazing: 'üßÄ',
  other: 'üç¥',
};

const templateOrder = [
  'plate',
  'bowl',
  'pasta-night',
  'soup-and-side',
  'one-pot',
  'grazing',
  'other',
];

function getRecipeTitle(slug: string): string {
  const recipe = recipeMap.get(slug);
  return recipe?.data.title || slug;
}
---

<Layout title="Meals | Mise">
  <div class="max-w-4xl mx-auto">
    {/* Page Header */}
    <header class="mb-10">
      <h1 class="text-3xl font-bold text-slate-900 mb-2">Meal Compositions</h1>
      <p class="text-lg text-slate-600">
        Complete meals combining recipes for balanced, delicious dining. 
        <span class="text-slate-500">{meals.length} meals available.</span>
      </p>
    </header>

    {/* Template Sections */}
    {templateOrder
      .filter((t) => mealsByTemplate[t]?.length)
      .map((template) => (
        <section class="mb-12">
          {/* Section Header */}
          <div class="flex items-center gap-3 mb-6 pb-3 border-b border-slate-200">
            <span class="text-2xl">{templateIcons[template]}</span>
            <div>
              <h2 class="text-xl font-semibold text-slate-900">
                {templateLabels[template]}
              </h2>
              <p class="text-sm text-slate-500">{templateDescriptions[template]}</p>
            </div>
          </div>

          {/* Meal Cards */}
          <div class="space-y-4">
            {mealsByTemplate[template].map((meal) => (
              <a
                href={`${import.meta.env.BASE_URL}meals/${meal.slug}`}
                class="block bg-white rounded-xl border border-slate-200 p-5 hover:border-indigo-300 hover:shadow-lg transition-all group"
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-lg text-slate-900 group-hover:text-indigo-600 transition-colors mb-2">
                      {meal.data.title}
                    </h3>
                    
                    {/* Recipe Components Preview */}
                    <div class="flex flex-wrap gap-2 text-sm">
                      {meal.data.main && (
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-slate-100 text-slate-700 rounded-full">
                          <span class="text-slate-400">Main:</span>
                          {getRecipeTitle(meal.data.main)}
                        </span>
                      )}
                      {meal.data.sides && meal.data.sides.length > 0 && (
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-slate-100 text-slate-600 rounded-full">
                          +{meal.data.sides.length} side{meal.data.sides.length > 1 ? 's' : ''}
                        </span>
                      )}
                    </div>

                    {/* Best For Tags */}
                    {meal.data.bestFor && meal.data.bestFor.length > 0 && (
                      <div class="flex flex-wrap gap-1.5 mt-3">
                        {meal.data.bestFor.map((day) => (
                          <span class="text-xs font-medium px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded">
                            {day}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Arrow */}
                  <div class="flex-shrink-0 mt-1">
                    <svg class="w-5 h-5 text-slate-300 group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </section>
      ))
    }

    {/* Empty State */}
    {meals.length === 0 && (
      <div class="text-center py-16">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
          <span class="text-3xl">üçΩÔ∏è</span>
        </div>
        <p class="text-slate-500 text-lg">No meals created yet.</p>
        <p class="text-slate-400 text-sm mt-1">Meal compositions will appear here.</p>
      </div>
    )}
  </div>
</Layout>
